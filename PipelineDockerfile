# Start from the latest Ubuntu image
FROM ubuntu:latest

# Switch to root user to perform installations
USER root

# Update package lists and install necessary packages: Git, JDK, Docker, wget
RUN apt-get update -yqq && \
    apt-get install -yqq git openjdk-8-jdk wget \
        ca-certificates curl gnupg \
        apt-transport-https \
        software-properties-common && \
    echo "Git, JDK, and basic tools installed successfully"

# Install Docker CE
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo \
    "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
    $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update -yqq && \
    apt-get install -yqq docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose && \
    echo "Docker installed successfully"

# Install Maven
ENV MAVEN_VERSION=3.8.4
ENV MAVEN_HOME=/opt/maven
ENV MAVEN_DOWNLOAD_URL=https://downloads.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz

RUN mkdir -p ${MAVEN_HOME} && \
    curl -fsSL ${MAVEN_DOWNLOAD_URL} | tar -xzC ${MAVEN_HOME} --strip-components=1 && \
    update-alternatives --install /usr/bin/mvn mvn ${MAVEN_HOME}/bin/mvn 1001 && \
    echo "Maven installed successfully"

# Install Nexus Repository Manager
ENV NEXUS_VERSION=3.36.0-02
ENV NEXUS_DOWNLOAD_URL=https://download.sonatype.com/nexus/3/nexus-${NEXUS_VERSION}-unix.tar.gz
ENV NEXUS_HOME=/opt/nexus
ENV NEXUS_DATA=/nexus-data

RUN wget -q ${NEXUS_DOWNLOAD_URL} -O /tmp/nexus.tar.gz && \
    mkdir -p ${NEXUS_HOME} && \
    tar -zxvf /tmp/nexus.tar.gz --strip-components=1 -C ${NEXUS_HOME} && \
    rm /tmp/nexus.tar.gz && \
    adduser --disabled-login --gecos '' nexus && \
    mkdir -p ${NEXUS_DATA} && \
    chown -R nexus:nexus ${NEXUS_HOME} ${NEXUS_DATA} && \
    echo "Nexus installed successfully"

# Expose Nexus port
EXPOSE 8081

# Set Nexus to run as the nexus user
USER nexus

# Start Nexus
CMD ${NEXUS_HOME}/bin/nexus run
